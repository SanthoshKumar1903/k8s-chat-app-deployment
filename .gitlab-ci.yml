stages:
  - deploy

deploy_to_server:
  stage: deploy
  image: alpine:latest
  
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - when: manual

  before_script:
    - 'command -v ssh-agent >/dev/null || ( apk add --update openssh-client )'
    - chmod 600 "$SSH_KEY"

  script:
    - |
      ssh -v -i "$SSH_KEY" \
          -o StrictHostKeyChecking=no \
          -o IdentitiesOnly=yes \
          ${SERVER_USER}@${SERVER_IP} 'bash -s' << 'ENDSSH'
        set -e
        echo '--- Connected to server ---'

        if ! command -v docker &> /dev/null; then
          echo 'Docker not found. Installing...'
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates curl
          sudo install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          sudo chmod a+r /etc/apt/keyrings/docker.gpg
          echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
          $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
          sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
          if ! getent group docker > /dev/null; then
            echo "Docker group not found. Creating..."
            sudo groupadd docker
          fi
          sudo usermod -aG docker \${USER}
        else
          echo 'Docker is already installed.'
        fi

        if ! command -v minikube &> /dev/null; then
          echo 'Minikube not found. Installing...'
          curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          sudo install minikube-linux-amd64 /usr/local/bin/minikube && rm minikube-linux-amd64
          newgrp docker << END
          minikube start --driver=docker
          END
        else
          echo 'Minikube is already installed.'
          newgrp docker << END
          minikube status || minikube start --driver=docker
          END
        fi

        PROJ_DIR=\"full-stack-app\"
        
        # Check if the directory exists
        if [ ! -d \"\$PROJ_DIR\" ]; then
          echo '--- Cloning repository for the first time ---'
          git clone https://github.com/SanthoshKumar1903/k8s-chat-app-deployment \"\$PROJ_DIR\"
        else
          echo '--- Repository exists, pulling latest changes ---'
          cd \"\$PROJ_DIR\"
          git pull origin main
        fi
        
        cd \"\$PROJ_DIR\"
        
        echo '--- Applying Kubernetes manifests ---'
        minikube kubectl -- apply -f kubernetes/
        
        echo '--- Deployment finished ---'
      "
